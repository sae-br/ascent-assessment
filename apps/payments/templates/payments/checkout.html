{% extends "base.html" %}
{% load static %}
{% block title %}Final Report Checkout{% endblock %}

{% block content %}
<section class="section">
  <h1>Purchasing Your Final Report</h1>
  <p>Have you ensured all participants have submitted their answers?</p>
  <p><strong>Once you purchase the report, this assessment will be closed.
    This action cannot be reversed.</strong></p>
  <p>After payment, weâ€™ll generate your final PDF report.</p>
</section>

<div class="grid">
  <div class="grid--payment">

    <!-- LEFT COLUMN -->
    <div class="column--payments">
      <div class="card">
        <h2>Billing Details</h2>
        <div id="billing-address"><!-- Stripe Address Element here --></div>
      </div>

      <div class="card">
        <h2>Payment Method</h2>
        <div id="payment-form"><!-- Stripe card element here --></div>
      </div>
    </div>

    <!-- RIGHT COLUMN (Sticky)-->
    <div class="column--payments">
      <div class="card summary-card summary-sticky" id="price-summary"
          data-original="{{ original_amount_minor|default:'' }}"
          data-discount="{{ discount_minor|default:'' }}"
          data-final="{{ final_amount_minor|default:'' }}"
          data-tax="{{ tax_minor|default:'0' }}"
          data-currency="CAD">
        <h2>Order Summary</h2>

        <div class="price-lines" aria-live="polite" aria-atomic="true">
          <p><span>Subtotal</span><span id="ps-subtotal">$750.00</span></p>
          <p><span>Discount</span><span id="ps-discount">$0.00</span></p>
          <p><span>Tax</span><span id="ps-tax">$0.00</span></p>
          <p class="total-line"><span>Total</span><span id="ps-total">$750.00</span></p>
        </div>
        <p class="helptext">
          All amounts in CAD. Tax is calculated at checkout based on your billing address.
        </p>

        <form class="promo-inline" onsubmit="return false;">
          {% csrf_token %}
          <div id="promo-area" class="promo-code">
            <label for="id_promo" class="visually-hidden">Promo code</label>
            <input type="text" name="promo_code" id="id_promo" value="{{ applied_code|default:'' }}" placeholder="Promo code" />
            <button type="button" id="apply-promo" class="button button--secondary">Apply</button>

            {% if promo_error %}
              <p class="text-error" role="alert">{{ promo_error }}</p>
            {% elif applied_code %}
              <p class="text-success">Applied <strong>{{ applied_code }}</strong></p>
            {% endif %}
          </div>
        </form>

        <p class="helptext">By clicking Pay, you agree to our Terms and Privacy Policy. Taxes are 
          calculated based on your billing address. A receipt will be emailed 
          to {{ request.user.email }}.
        </p>
        <button id="pay-btn" class="button--primary full-width">Pay now</button>
        <p id="error-text" class="text-danger" style="margin-top:.5rem;"></p>
      </div>
    </div>
    <!-- Runtime config for checkout.js (no inline JS) -->
    <div id="checkout-config"
        data-publishable-key="{{ stripe_publishable_key }}"
        data-client-secret="{{ client_secret }}"
        data-return-url="{{ success_url }}"
        data-assessment-id="{{ assessment_id }}">
    </div>

  </div>
</div>

<script src="https://js.stripe.com/v3/"></script>
<script src="{% static 'payments/scripts/checkout.js' %}" defer></script>
{% endblock %}