{% comment %}
Reusable member table.
Context:
- team (required)
- selected_team (optional; falls back to team)
- use_htmx (bool) -> when true, forms post via HTMX to teams:member_table and swap #member-table
- form_action (optional non-JS fallback). If omitted, defaults to teams:teams_overview
{% endcomment %}

{% if team %}
  {% url 'teams:teams_overview' as default_action %}
  {% url 'teams:member_table' team.id as htmx_url %}
  {% with action_url=form_action|default:default_action %}
  
  <div id="member-table">
    <h3>Team Members in {{ team.name }}</h3>

    <div class="table-wrapper">
      <table class="table">
        <colgroup>
          <col style="width: 35%">
          <col style="width: 40%">
          <col>
        </colgroup>
        <thead>
          <tr>
            <th>Name</th>
            <th>Email</th>
            <th class="rightmost-column">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for member in team.members.all %}
            <tr>
              <form method="post"
                    action="{{ action_url }}"
                    {% if use_htmx %}hx-post="{{ htmx_url }}" hx-target="#member-table" hx-swap="outerHTML"{% endif %}
                    style="display: contents;">
                {% csrf_token %}
                <input type="hidden" name="selected_team" value="{{ selected_team.id|default:team.id }}">
                <input type="hidden" name="member_id" value="{{ member.id }}">

                <td data-label="Name">
                  <input type="text" name="edit_member_name" value="{{ member.name }}" required>
                </td>
                <td data-label="Email">
                  <input type="email" name="edit_member_email" value="{{ member.email }}" required>
                </td>
                <td class="actions-cell" data-label="Actions">
                  {% if confirm_id and confirm_id|stringformat:"s" == member.id|stringformat:"s" %}
                    <div class="actions-stack">
                      <span class="text-button" style="color: var(--alert);">Delete this member?</span>
                      <button type="button"
                              class="text-button"
                              hx-post="{{ htmx_url }}"
                              hx-target="#member-table"
                              hx-swap="outerHTML"
                              hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
                              hx-vals='{"delete_member": "1", "member_id": "{{ member.id }}", "selected_team": "{{ selected_team.id|default:team.id }}"}'>
                        Yes, delete
                      </button>
                      <span class="actions-sep" aria-hidden="true">|</span>
                      <a href="#"
                         class="text-button"
                         {% if use_htmx %}hx-get="{{ htmx_url }}" hx-target="#member-table" hx-swap="outerHTML"{% endif %}>
                        Cancel
                      </a>
                    </div>
                  {% else %}
                    <div class="actions-stack">
                      <button type="submit" name="edit_member" class="text-button">Update</button>
                      <span class="actions-sep" aria-hidden="true">|</span>
                      <a href="#"
                         class="text-button"
                         {% if use_htmx %}hx-get="{{ htmx_url }}?confirm={{ member.id }}" hx-target="#member-table" hx-swap="outerHTML"{% endif %}>
                        Delete
                      </a>
                    </div>
                  {% endif %}
                </td>
              </form>
            </tr>
          {% empty %}
            <tr><td colspan="3">No members yet.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <form method="post"
          action="{{ action_url }}"
          class="form--extend-table"
          {% if use_htmx %}
            hx-post="{{ htmx_url }}" 
            hx-target="#member-table" 
            hx-swap="outerHTML"
          {% endif %}>
      <p><em>Add New Member:</em></p>
      {% csrf_token %}
      <input type="hidden" name="selected_team" value="{{ selected_team.id|default:team.id }}">
      <input type="text"  name="new_member_name"  placeholder="Name"  required>
      <input type="email" name="new_member_email" placeholder="Email" required>
      <button type="submit" name="add_member" class="button">Add</button>
    </form>
  </div>

  {% endwith %}
{% endif %}