{% extends "base.html" %}
{% load static %}

{% block content %}
  <div class="main-heading">
    <h1>Teams</h1>
  </div>

  <!-- Create a New Team -->
  <section class="section">
    <h2>Create a New Team</h2>
    <p>Create a new team here and you will be able to select it in the dropdown below.</p>
    <form method="post" class="team-create-form" action="{% url 'teams:teams_overview' %}">
      {% csrf_token %}
      <input type="text" name="name" placeholder="Enter Team Name" required class="team-input">
      <button type="submit" name="create_team" class="button">Create</button>
    </form>
  </section>

  <!-- Edit / Manage a Team -->
  <section class="section">
    <h2>Edit a Team</h2>

    <!-- switcher dropdown -->
    <form method="post" class="team-switch-form" action="{% url 'teams:teams_overview' %}">
      {% csrf_token %}
      <label for="selected_team">Select the team youâ€™d like to edit:</label>
      <div class="team-switch">
        <select name="selected_team" id="selected_team">
          <option value="" disabled {% if not selected_team %}selected{% endif %}>-- Select Team --</option>
          {% for t in teams %}
            <option value="{{ t.id }}" {% if selected_team and t.id == selected_team.id %}selected{% endif %}>
              {{ t.name }}
            </option>
          {% endfor %}
        </select>
        <button type="submit" name="edit_team" class="button">Go</button>
      </div>
    </form>

    {% if selected_team %}
      {% include "teams/_member_table.html" with team=selected_team use_htmx=True %}

      <!-- Rename Team -->
      <form method="post" class="form--extend-table" action="{% url 'teams:rename_team' selected_team.id %}">
        {% csrf_token %}
        <p><em>Rename Team:</em></p>
        <input type="text" name="name" value="{{ selected_team.name }}" required>
        <button type="submit" class="button">Rename</button>
      </form>
      
      <!-- Delete Team (HTMX double-confirm) -->
      <hr>
      <div id="delete-team-block" class="section" style="margin-top:1rem;">
        {% if request.GET.confirm_team and request.GET.confirm_team|stringformat:"s" == selected_team.id|stringformat:"s" %}
          <div class="actions-stack">
            <span class="text-button" style="color: var(--alert);">
              Delete the team <strong>{{ selected_team.name }}</strong> and remove all of its members from your account?
              <small class="para-small" style="color: var(--text-light); display:block; margin-top:.15rem;">
                The team record and its member records will be permanently deleted.<br>
                <strong>Launched assessments and existing reports related to this team will not be deleted</strong>; their invitations and results use participant snapshots and will continue to work.<br>
              </small>
            </span>
            <form method="post" action="{% url 'teams:delete_team' selected_team.id %}" style="display:inline;">
              {% csrf_token %}
              <button type="submit" class="text-button" style="color: var(--alert);">Yes, delete</button>
            </form>
            <span class="actions-sep" aria-hidden="true">|</span>
            <a href="#"
               class="text-button"
               hx-get="{% url 'teams:teams_overview' %}?selected_team={{ selected_team.id }}"
               hx-target="#delete-team-block"
               hx-select="#delete-team-block"
               hx-swap="outerHTML">
              Cancel
            </a>
          </div>
        {% else %}
          <form method="post" action="{% url 'teams:delete_team' selected_team.id %}" style="display:inline;">
            {% csrf_token %}
            <a href="#"
               class="text-button"
               style="color: var(--alert);"
               hx-get="{% url 'teams:teams_overview' %}?confirm_team={{ selected_team.id }}&selected_team={{ selected_team.id }}"
               hx-target="#delete-team-block"
               hx-select="#delete-team-block"
               hx-swap="outerHTML">
              Delete Team
            </a>
          </form>
        {% endif %}
      </div>
    {% endif %}
  </section>
{% endblock %}