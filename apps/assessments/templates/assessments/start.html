{% extends "base_public.html" %}
{% block title %}Ascent Assessment for Teams{% endblock %}

{% block content %}
<form id="assessment-form" method="post" class="assessment-form">
  {% csrf_token %}

  <!-- Progress -->
  <div class="progress-wrap" aria-hidden="true">
    <div class="progress-bar">
      <span class="progress-fill"></span>
    </div>
    <div class="progress-meta">
      <span class="progress-text">
        <strong>Step <span id="stepNum">1</span></strong> of
        <span id="stepTotal">1</span>
      </span>
    </div>
  </div>

  <div id="steps">
    <!-- Intro step -->
    <section class="step is-active" data-step="0" aria-label="Introduction">
        <h2>Hello, {{ member.name }}!</h2>
        <p>Please take a few minutes to answer the following questions honestly. Youâ€™ll move one question at a time. Your answers are saved when you submit on the last step.</p>
    </section>

    <!-- One step per question -->
    {% for question in questions %}
    <section class="step" data-step="{{ forloop.counter }}" aria-labelledby="q{{ forloop.counter }}">
      <fieldset class="question-card">
        <legend id="q{{ forloop.counter }}"><strong>{{ forloop.counter }}.</strong> {{ question.text }}</legend>

        <div class="choices">

            <!-- 0 -->
            <label class="choice">
                <input class="visually-hidden" type="radio" name="question_{{ question.id }}" value="0" required>
                <span class="choice-label">
                <span class="choice-text">Consistently</br>Untrue</span>
                </span>
            </label>
            <!-- 1 -->
            <label class="choice">
                <input class="visually-hidden" type="radio" name="question_{{ question.id }}" value="1" required>
                <span class="choice-label">
                <span class="choice-text">Somewhat</br>Untrue</span>
                </span>
            </label>
            <!-- 2 -->
            <label class="choice">
                <input class="visually-hidden" type="radio" name="question_{{ question.id }}" value="2" required>
                <span class="choice-label">
                <span class="choice-text">Somewhat</br>True</span>
                </span>
            </label>
            <!-- 3 -->
            <label class="choice">
                <input class="visually-hidden" type="radio" name="question_{{ question.id }}" value="3" required>
                <span class="choice-label">
                <span class="choice-text">Consistently</br>True</span>
                </span>
            </label>
        </div>
      </fieldset>
    </section>
    {% endfor %}

    <!-- Final step -->
    <section class="step" data-step="final" aria-label="Review and Submit">
      <p>All done! When you click submit, your answers will be recorded.</p>
      <button type="submit" class="button--primary">Submit</button>
    </section>
  </div>

  <!-- Inline validation message area -->
  <div id="formError" class="form-error" hidden>Please select an option to continue.</div>

  <!-- Pager controls -->
  <div class="pager">
    <button type="button" class="button--secondary" id="prevBtn" disabled>Back</button>
    <button type="button" class="button--secondary" id="nextBtn">Next</button>
  </div>
</form>

<script>
(function () {
  const steps = Array.from(document.querySelectorAll('.step'));
  const totalSteps = steps.length; // intro + N questions + final
  const stepTotalEl = document.getElementById('stepTotal');
  const stepNumEl = document.getElementById('stepNum');
  const progressFill = document.querySelector('.progress-fill');
  const prevBtn = document.getElementById('prevBtn');
  const nextBtn = document.getElementById('nextBtn');
  const formError = document.getElementById('formError');

  stepTotalEl.textContent = totalSteps;

  let idx = 0; // active step index

  function show(i) {
    clearError();
    steps.forEach((s, n) => s.classList.toggle('is-active', n === i));

    // Back button behavior
    const onIntro = i === 0;
    prevBtn.style.visibility = onIntro ? 'hidden' : 'visible';
    prevBtn.disabled = onIntro; 
    prevBtn.setAttribute('aria-hidden', onIntro ? 'true' : 'false');

    // Next button on last step
    const onLast = i === totalSteps - 1;
    nextBtn.style.display = onLast ? 'none' : '';
    nextBtn.disabled = false; 

    // Progress + step number
    stepNumEl.textContent = i + 1;
    const pct = Math.round((i / (totalSteps - 1)) * 100);
    progressFill.style.width = pct + '%';
  }

  function currentQuestionAnswered() {
    const active = steps[idx];
    const radios = active.querySelectorAll('input[type="radio"][name^="question_"]');
    if (!radios.length) return true; // intro and final step have no radios
    return Array.from(radios).some(r => r.checked);
  }

  function showError(msg) {
    if (!formError) return;
    formError.textContent = msg || 'Please select an option to continue.';
    formError.hidden = false; 
  }
  function clearError() {
    if (!formError) return;
    formError.hidden = true; 
  }

  nextBtn.addEventListener('click', function () {
    if (!currentQuestionAnswered()) {
      showError('Please select an option to continue.');
      const first = steps[idx].querySelector('input[type="radio"]');
      if (first) first.focus();
      return;
    }
    clearError();
    if (idx < totalSteps - 1) {
      idx += 1;
      show(idx);
    }
  });

  prevBtn.addEventListener('click', function () {
    if (idx > 0) {
      idx -= 1;
      show(idx);
    }
  });

  // Make the whole label clickable and reflect selected state
  document.querySelectorAll('.choice').forEach(lbl => {
    lbl.addEventListener('click', () => {
      const input = lbl.querySelector('input[type="radio"]');
      if (!input) return;
      input.checked = true;

      // Clear selected state for this radio group
      const groupName = input.name;
      document.querySelectorAll(`input[name="${groupName}"]`).forEach(r => {
        const l = r.closest('.choice');
        if (l) l.classList.remove('is-selected');
      });

      // Set selected state for the clicked label
      lbl.classList.add('is-selected');
      clearError();
    });
  });

  // Keep selected styling in sync when using keyboard
  document.querySelectorAll('input[type="radio"]').forEach(r => {
    r.addEventListener('change', (e) => {
      const groupName = r.name;
      document.querySelectorAll(`input[name="${groupName}"]`).forEach(rr => {
        const l = rr.closest('.choice');
        if (l) l.classList.toggle('is-selected', rr.checked);
      });
      clearError();
    });
  });

  show(0);
})();
</script>
{% endblock %}